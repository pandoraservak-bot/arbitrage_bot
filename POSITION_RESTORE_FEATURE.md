# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ü–æ–∑–∏—Ü–∏–π –ü—Ä–∏ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ

## –û–ø–∏—Å–∞–Ω–∏–µ
–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –º–µ—Ö–∞–Ω–∏–∑–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø–æ—Ç–µ—Ä—é –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ–∑–∏—Ü–∏—è—Ö –≤ —Å–ª—É—á–∞–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

## –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

### 1. –°–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–∑–∏—Ü–∏–π
–í –∫–ª–∞—Å—Å `Position` –¥–æ–±–∞–≤–ª–µ–Ω—ã –º–µ—Ç–æ–¥—ã:
- `to_dict()` - —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–∑–∏—Ü–∏–∏ –≤ —Å–ª–æ–≤–∞—Ä—å –¥–ª—è JSON
- `from_dict()` - –¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–∑–∏—Ü–∏–∏ –∏–∑ —Å–ª–æ–≤–∞—Ä—è

### 2. –•—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–π
–ü–æ–∑–∏—Ü–∏–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ —Ñ–∞–π–ª `data/positions.json` —Å–æ —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π:
```json
{
  "positions": [
    {
      "id": "pos_000000",
      "direction": "H‚ÜíB",
      "entry_time": 1734948000.0,
      "contracts": 1.5,
      "entry_prices": {"buy": 171.5, "sell": 171.8},
      "entry_spread": 0.175,
      "entry_slippage": {...},
      "exit_target": -0.05,
      "status": "open",
      "current_exit_spread": -0.03,
      "last_spread_update": 1734948100.0,
      "spread_history": [0.175, 0.12, 0.08],
      "update_count": 3,
      "exit_time": null,
      "exit_reason": null,
      "exit_prices": null,
      "final_pnl": null
    }
  ],
  "position_counter": 1,
  "last_saved": "2024-12-23T10:00:00"
}
```

### 3. –ú–µ—Ç–æ–¥—ã ArbitrageEngine

#### `_save_positions()`
–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤—Å–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –≤ —Ñ–∞–π–ª. –í—ã–∑—ã–≤–∞–µ—Ç—Å—è:
- –ü–æ—Å–ª–µ –æ—Ç–∫—Ä—ã—Ç–∏—è –Ω–æ–≤–æ–π –ø–æ–∑–∏—Ü–∏–∏
- –ü–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–∏
- –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–µ (–∫–∞–∂–¥—ã–µ 10 –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π —Å–ø—Ä–µ–¥–∞)
- –ü—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Ä–∞–±–æ—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

#### `_load_positions()`
–ó–∞–≥—Ä—É–∂–∞–µ—Ç –ø–æ–∑–∏—Ü–∏–∏ –∏–∑ —Ñ–∞–π–ª–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏. –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç:
- –í—Å–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ –ø–æ–∑–∏—Ü–∏–∏
- –°—á–µ—Ç—á–∏–∫ –ø–æ–∑–∏—Ü–∏–π –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –Ω—É–º–µ—Ä–∞—Ü–∏–∏ –Ω–æ–≤—ã—Ö
- –ò—Å—Ç–æ—Ä–∏—é —Å–ø—Ä–µ–¥–æ–≤
- –°–æ—Å—Ç–æ—è–Ω–∏–µ –∫–∞–∂–¥–æ–π –ø–æ–∑–∏—Ü–∏–∏

### 4. –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª

```
–ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    ‚Üì
ArbitrageEngine.initialize()
    ‚Üì
_load_positions() ‚Üê –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø–æ–∑–∏—Ü–∏–∏ –∏–∑ —Ñ–∞–π–ª–∞
    ‚Üì
–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ–∑–∏—Ü–∏–π
    ‚Üì
–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø—Ä–µ–¥–æ–≤ ‚Üí _save_positions() (–∫–∞–∂–¥—ã–µ 10 –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π)
    ‚Üì
–û—Ç–∫—Ä—ã—Ç–∏–µ –Ω–æ–≤–æ–π –ø–æ–∑–∏—Ü–∏–∏ ‚Üí _save_positions()
    ‚Üì
–ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–∑–∏—Ü–∏–∏ ‚Üí _save_positions()
    ‚Üì
–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã ‚Üí _save_positions()
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
```bash
# –ü—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏/—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
python3 test_position_restore.py

# –ü–æ–ª–Ω—ã–π —Ç–µ—Å—Ç –∂–∏–∑–Ω–µ–Ω–Ω–æ–≥–æ —Ü–∏–∫–ª–∞
python3 test_full_lifecycle.py
```

### –°—Ü–µ–Ω–∞—Ä–∏–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

#### –¢–µ—Å—Ç 1: –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞
1. –û—Ç–∫—Ä—ã—Ç—å –ø–æ–∑–∏—Ü–∏—é
2. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
3. –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å–Ω–æ–≤–∞
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –ø–æ–∑–∏—Ü–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ —Å–æ –≤—Å–µ–º–∏ –¥–∞–Ω–Ω—ã–º–∏

#### –¢–µ—Å—Ç 2: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø—Ä–µ–¥–æ–≤
1. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é
2. –û–±–Ω–æ–≤–∏—Ç—å —Å–ø—Ä–µ–¥—ã –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑
3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –∏—Å—Ç–æ—Ä–∏—è —Å–ø—Ä–µ–¥–æ–≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞

#### –¢–µ—Å—Ç 3: –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–∑–∏—Ü–∏–∏
1. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é
2. –ó–∞–∫—Ä—ã—Ç—å –ø–æ–∑–∏—Ü–∏—é
3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –ø–æ–∑–∏—Ü–∏–π –Ω–µ—Ç (–ø—É—Å—Ç–æ–π —Ñ–∞–π–ª)

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
–ù–µ —Ç—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π - –≤—Å–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
```python
# –ü–æ–∑–∏—Ü–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è
await arb_engine.execute_opportunity(opportunity)

# –°–æ—Å—Ç–æ—è–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è
arb_engine.monitor_positions(bitget_data, hyper_data)

# –ü–æ–∑–∏—Ü–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
arb_engine.close_position(position, spread, reason)
```

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
–ü—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–≤–∏–∂–∫–∞ –ø–æ–∑–∏—Ü–∏–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
```python
arb_engine = ArbitrageEngine(risk_manager, paper_executor)
await arb_engine.initialize()  # ‚Üê –ó–∞–≥—Ä—É–∂–∞–µ—Ç –ø–æ–∑–∏—Ü–∏–∏

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π
open_positions = arb_engine.get_open_positions()
print(f"Restored {len(open_positions)} positions")
```

## –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω
–ï—Å–ª–∏ —Ñ–∞–π–ª `positions.json` –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (–ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫), –≤—ã–≤–æ–¥–∏—Ç—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ —Å–æ–∑–¥–∞–µ—Ç—Å—è –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ –ø–æ–∑–∏—Ü–∏–π.

### –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞
–ï—Å–ª–∏ —Ñ–∞–π–ª –ø–æ–≤—Ä–µ–∂–¥–µ–Ω –∏–ª–∏ –∏–º–µ–µ—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç, –æ—à–∏–±–∫–∞ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è, –Ω–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç—É —Å –ø—É—Å—Ç—ã–º —Å–ø–∏—Å–∫–æ–º –ø–æ–∑–∏—Ü–∏–π.

### –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
–ï—Å–ª–∏ –Ω–µ —É–¥–∞–µ—Ç—Å—è —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ–∑–∏—Ü–∏–∏, –æ—à–∏–±–∫–∞ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è, –Ω–æ –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç —Ä–∞–±–æ—Ç—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

## –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
```
INFO: No saved positions file found - starting fresh
INFO: ‚úÖ Restored position: pos_000000, Direction: H‚ÜíB, Age: 00:15:23, ...
INFO: üîÑ Restored 1 open position(s) from previous session
```

### –ü—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏
```
DEBUG: Saved 1 open position(s) to data/positions.json
```

### –ü—Ä–∏ –æ—à–∏–±–∫–∞—Ö
```
ERROR: Error loading positions: <error details>
ERROR: Error saving positions: <error details>
```

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

1. **–ù–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã** - –ø–æ–∑–∏—Ü–∏–∏ –Ω–µ —Ç–µ—Ä—è—é—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ
2. **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å** - –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –Ω–∞ –¥–∏—Å–∫
3. **–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å** - JSON —Ñ–æ—Ä–º–∞—Ç –ª–µ–≥–∫–æ —á–∏—Ç–∞–µ—Ç—Å—è –∏ –æ—Ç–ª–∞–∂–∏–≤–∞–µ—Ç—Å—è
4. **–ê–≤—Ç–æ–º–∞—Ç–∏–∑–º** - –Ω–µ —Ç—Ä–µ–±—É–µ—Ç —Ä—É—á–Ω–æ–≥–æ –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–∞
5. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** - –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç —Å–±–æ–µ–≤

## –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

1. –¢–æ–ª—å–∫–æ –æ—Ç–∫—Ä—ã—Ç—ã–µ –ø–æ–∑–∏—Ü–∏–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è (–∑–∞–∫—Ä—ã—Ç—ã–µ –∏–¥—É—Ç –≤ trade_history)
2. –§–∞–π–ª –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø—Ä–∏ –∫–∞–∂–¥–æ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏
3. –¢—Ä–µ–±—É–µ—Ç—Å—è –¥–æ—Å—Ç—É–ø –Ω–∞ –∑–∞–ø–∏—Å—å –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é `data/`

## –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

- –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ –ø–æ–∑–∏—Ü–∏–π
- –°–∂–∞—Ç–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —Å–ø—Ä–µ–¥–æ–≤ –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –º–µ—Å—Ç–∞
- –ú–∏–≥—Ä–∞—Ü–∏—è —Å—Ç–∞—Ä—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ –¥–∞–Ω–Ω—ã—Ö
- –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π (trade_history)
