# Реализация Восстановления Позиций - Краткое Описание

## Проблема
При перезапуске приложения открытые позиции терялись, так как они хранились только в памяти.

## Решение
Реализован механизм автоматического сохранения и восстановления открытых позиций через файл `data/positions.json`.

## Изменения в Коде

### 1. core/arbitrage_engine.py
**Добавленные импорты:**
- `json`, `os` для работы с файлами
- `asdict` из `dataclasses` для сериализации
- `datetime` для временных меток

**Новые методы в классе Position:**
- `to_dict()` - сериализация позиции в словарь
- `from_dict(cls, data)` - десериализация позиции из словаря

**Новые методы в классе ArbitrageEngine:**
- `_save_positions()` - сохранение открытых позиций в JSON файл
- `_load_positions()` - загрузка позиций из JSON файла

**Изменения в существующих методах:**
- `__init__()` - добавлен путь к файлу позиций
- `initialize()` - добавлен вызов `_load_positions()`
- `execute_opportunity()` - добавлен вызов `_save_positions()` после открытия
- `close_position()` - добавлен вызов `_save_positions()` после закрытия
- `monitor_positions()` - добавлено периодическое сохранение (каждые 10 обновлений)

### 2. main.py
**Изменения в методе shutdown():**
- Добавлено сохранение позиций перед завершением работы
- Логирование количества сохраняемых позиций

## Файлы

### data/positions.json
Структура файла:
```json
{
  "positions": [/* массив открытых позиций */],
  "position_counter": 0,
  "last_saved": "2024-12-23T10:00:00"
}
```

### POSITION_RESTORE_FEATURE.md
Полная документация функции с примерами использования.

## Тестирование

Все тесты успешно пройдены:
- ✅ Загрузка позиций из файла
- ✅ Сохранение позиций в файл
- ✅ Восстановление после перезапуска
- ✅ Обновление спредов и повторное сохранение
- ✅ Закрытие позиций и очистка файла
- ✅ Интеграционный тест с полным жизненным циклом

## Поведение

### При запуске
1. ArbitrageEngine загружает позиции из `data/positions.json`
2. Если файл не существует - начинает с пустого списка
3. Восстановленные позиции логируются с полной информацией

### Во время работы
1. После открытия позиции → автоматическое сохранение
2. Каждые 10 обновлений спреда → автоматическое сохранение
3. После закрытия позиции → автоматическое сохранение

### При остановке
1. Сохранение всех открытых позиций
2. Логирование количества сохраненных позиций

## Критерии Приемки

- ✅ Открытые позиции восстанавливаются при запуске приложения
- ✅ Восстановленные позиции корректно отслеживаются в реальном времени
- ✅ История спредов и статистика восстанавливаются
- ✅ Нет потери данных при перезапуске приложения

## Безопасность

- Обработка ошибок при чтении/записи файла
- Приложение продолжает работу даже если файл поврежден
- Автоматическое создание директории `data/` если не существует
- Логирование всех ошибок

## Производительность

- Минимальное влияние на производительность
- Сохранение в фоновом режиме (не блокирует основной цикл)
- Периодическое сохранение только при наличии изменений
- JSON формат для быстрого парсинга

## Совместимость

- Работает со всеми существующими функциями бота
- Не требует изменений в конфигурации
- Обратная совместимость (старые файлы игнорируются)
